ch
光大证券事件停止真的是靠拔电源吗？[转]
 第一：不可信。 第二：一般情况下，程序不会停都停不住，很快就跑完了交易，来不及停倒有可能。 第三：真出现程序停都停不住的状况，IT人员有超过10种办法解决这个问题。拔电源是比较笨，慢，难的办法。而且只有专业人员才有能力拔电源，但没有专业人员会这么傻，所以不可信。 我刚才看到了这条同样内容的微博 weibo.com/1651428902/A5m6xABmh ，边吃饭边把接近400条评论都看了一次，里面只有不到十条评论是靠谱的。借题发挥是我的爱好，先列个八股文的提纲和先写完第一条。有赞使得老鬼推车啊， 每100赞的话我就高速更新一条，没鼓励动力不足我就慢慢更。大家有问题随便问，我边答边增加到文章里面去。后来越写越没心思，可能文理有点乱，用词也不 是很统一，大家将就着看看，反正又不用钱。 针对 同学对我的大力批评补一句：我一早说了，这是借题发挥。真要回答这个问题，三行我就写完了。我是看到微博上很多讨论是错误的，而且看上去这些都还是做IT的人员。所以我就这些错误，混杂上一些我认为大家可能关心的点，介绍一下而已，可以作为IT的科普文章，当然欢迎大家批评指正。而且姚同学要喷，也等我全部写完才喷啊。这么快就断定"可惜accc写那么多，全没一句靠谱的"，万一我补充一句：姚杨同学又帅又聪明，那这句到底算靠谱还是不靠谱呢？ 1) 不熟悉设备的人连机器都找不到，怎么拔？ 我们来看看事件的时间点：2013年8月16日上午11:05:08-10秒的时候，生成了26082笔预期外的委托订单。在11:07分，发现有异常，开始卖出IF1309空头合约。也就是说，如果真的要拔电源的话，是在11:05-11:07这两分钟内完成的。 大家可能有个误会：交易用的服务器就好像我们平时工作的电脑那样摆在桌面，近在咫尺。出事了，风紧，扯乎，扯电源！趴的一声设备掉电，整个世界恢复了平静... 但 实际情况是：桌子上的电脑一般只用来发发邮件，写写文档，装个终端软件连接到交易用的服务器上进行交易而已。运行证券交易（以下简称应用）的程序服务器都 在机房里面。机房不可以随便进，有各种门禁（常见的有密码，电子卡锁，掌纹指纹等，科幻电影中的什么语音虹膜的很少见）。进机房要打申请，要换拖鞋或者戴 鞋套套。机房对温度湿度洁净度都有各种要求，着火了就喷七氟丙烷、IG-541。没事闲人免进，有事需要进去的话，好多机房也规定要有客户的维护人员跟 随。只跟证券打交道的交易员可能买卖股票基金期货一辈子都没机会进机房，没见过这些服务器。这很正常的，钱钟书说过类似的话：大家吃了一辈子鸡蛋（大致是鸡鸡的大姨妈），也很少人把玩过鸡的泄殖孔嘛... 退一步来说，交易员就算进了机房，也会找不到设备： 证券公司的机房虽然比较小，但一般十个八个机柜几十台设备还是有的。不懂IT的交易员，连哪台是服务器，哪台是存储设备，哪台是网络设备都未必能分清楚。 不是专门维护的人员，就算我这种老油条，可能认得出所有的机器型号，也找不到对应某个应用的设备是那台。所以如果真有拔电源的事，只有光大内部IT维护的 人员才能找到机器。交易员通知到IT维护人员，还要找到机器，2分钟，够不够？ 2) 电源比萝卜还难拔！ 再退一步，就算设备上面有猪头大的标签"ETF套利专用设备"，业务人员冲到这台设备前面，想拔电源，也未必能找得到电源的位置：电源有的在前面，有的在后面，有的要把挡板卸掉才能拔。----电源不是你想拆，想拆就能拆 ，让我挣开，让我明白， 放手你的唉。 下图IBM服务器的双电源： 下图HP服务器的双电源 (一号电源已经被拔出来了，二号电源还装着，亮绿灯证明有加电） 证 券公司还好了，一般也就是中低端小型机（记忆中光大好像有IBM也有HP的设备，不知道具体本次事件相关的应用在什么设备上，当然还有可能在x86的服务 器上）。如果是银行的核心主机，很多是大型机，或者是最高端的小型机，电源大约在下面这个图的位置（整个服务器接近两米高），没经过训练，要拔都不知道怎 么拔。一般来说，用户都不懂，也不需要懂如何拔电源，这些都是专门的原厂硬件工程师的干活。 仔细想想：其实拔电源这个词也是很模糊的词，可以有几种理解： 1. 把电源模块残暴地从服务器中拔出来。 在 大家用的家用电脑上，由于电源是用螺丝固定在主板上的，所以基本上无法实现拔出来。但在专业服务器上面，电源模块是可以在机器运行的时候更换的。当然这里 面有很多学问，比如有的机器拔了电源之后如果3分钟内不把一个新的插回去的话，机器就会整个断电。硬件工程师每次换的时候都生死时速的样子。 2. 把电源线从电源模块中拔掉，这个比较好理解。 3. 电源上面一般都有开关，可以直接断电，这个也比较好理解。 电源拔出来了之后是这个样子： 3) 有UPS也没用！ 这是最常见的误解，之前的微博里面UPS这个词至少出现了50次，大家都在说，拔了电源机器就停了吗？不是有UPS（Uninterruptible Power System ，不间断电源）吗。这个反驳还真是错的。 这文章反馈不咋的，实在没心思详细写了，也懒得贴图了，简单来说，从市电到服务器之间的强电相关链条是这样的： 市电 ----UPS在这里 电源列头柜 机柜对外防水插头 机柜PDU ----要拔的电源在这里 服务器电源 拔了下游的电源，上游的UPS怎么能有作用呢？普通服务器上面又没电池，一拔就玩完，UPS鞭长莫及徒呼奈何。 4) 后备电源就有用了吗？ 太专业而无聊了，没兴趣写了。 5) 程序会停不下来吗？ 看 《环太平洋》的时候我都想吐槽了，这么先进的机器人居然要拔电源？科幻片就算了，光大这事件可是真实事件，真以为是天网作乱，智能机器人造反，只能拔电源 吗? 小时候看了卫斯理的《笔友》和《怪物》还真有点担心电脑作乱。真进入了这行之后才知道，放心，以现在广泛应用的电脑的智力，人类照顾少点电脑都会死，更不 要说作反了。想想，一个有五千年历史的老妖（人类），养了一个七十年的萝莉（计算机），要造反？相当于70岁的妈妈照顾1岁的婴儿，小宝贝别说造反了，喂 少一口奶都不行，走开一会还怕她乱滚滚到床底下呐... 扯远了，刚才@宋思源 在另一个回答中@我，提到套利触发没法终止。如果是运行时间很短，迅雷不及掩耳之势就完了，来不及终止，这很正常。但我的这篇文章是针对新闻中的说法"停都停不住只好拔电源"，这证明程序是一直在运行。可能在程序开发者角度没法终止，但在系统管理员角度，用系统命令杀进程，怎么会杀不死？毕竟，这运行的是高频交易软件，不是病毒啊；特别如果这软件运行在UNIX/Linux下，那就更不太可能停不下来了。就算正常的关闭方式不行，杀进程啊，一条kill -9 PID命令就都能杀掉99%的应用进程，有一堆进程就结合awk嘛。再不行，直接就一条命令马上关机：IBM AIX用halt -q , HP-UX用haltsys , 还有 poweroff, bye, shutdown, init 0之类一大堆咒语，触命令，尽死；立仆，无御之者。 来 点闷的：直接杀掉了进程之后对交易有什么影响？ 从交易系统或者中间件设计的角度，有个很重要的原则就是ACID (原子性Atomicity 一致性Consistency 隔离性Isolation 持久性Durability) ,A和C保证了应用系统不会受影响，只是某些交易会失败。 每次看到程序停不下来，我就想起这位不幸中的万幸的老兄： 6) 真出了程序停不下来的情况，除了拔电源，还有什么办法？ 拔电源最大的风险是系统可能出现不一致， 包括数据库不一致，文件系统不一致等等，原因是内存中的一些数据还没写回到硬盘中，最终会导致系统崩溃起不来。当然，OS在设计的时候已经考虑到这些问 题，比如AIX的JFS+fsck，Linux的reiserfs来实现系统断电自动修复方面比较安全，但Linux的ext2/3好多时候需要手动修 复，还不一定成功。这个话题展开可以出一本书，这里就不多说了。一句话就是拔电源是非正常关机，有风险，应该尽量避免。 而且，我们把场景需求设定在只中断这台服务器，而不是中断整个机房对外的服务。我一拍脑袋就可以拍到以下办法： 在服务器上用命令杀程序进程。 在服务器上用命令直接关机。 在服务器上用命令把网络服务，网卡停用，或者修改IP。 在服务器上，按关机按钮，UEPO开关。（变相的拔电源） 在服务器上，拔网线。 在机柜PDU上把供电关掉。（变相的拔电源） 在电源列头柜上把输电关掉。（变相的拔电源） 在网络设备（路由器/交换机/防火墙/F5/DNS等）把这台设备的网络链路断掉。就这一句就可以化出另外10种方法了。 看上去以上方法都是可以的，在网上各种讨论里面也被反复提出，但真的这样操作就可以吗？答案是不一定，在第七部分会详细讲述：拔电源拔网线就不能工作的服务器就是渣渣。 7) 拔网线vs拔电源线 从日常电脑使用的角度，好像听上去真的是这样：拔电源这么麻烦，还可能有数据丢失的风险，拔网线多简单，一拔就无法往外发数据，系统也不用关，回头插回网线就随时能恢复，多好。但实际上，在很关键的系统，拔什么都没用。因为正常的设计是：拔一个电源拔一条网线，系统都能继续运行。这是一种系统很重要的指标，叫做高可用指标，使用的是高可用技术。 高 可用技术主要分为三个层面，第一层是服务器本身的高可用，比如内存用ECC，硬盘用RAID，配备双电源等等，关键部件都有两份，坏了一份服务器还能跑。 不过考虑到在关键部件都坏了整台设备都垮了的情况下，就需要用到第二层：双机高可用技术，就是用另外一个设备，一般叫做冷备机/热备机顶上。（以下讨论只 基于最常见的两台机器组成的高可用系统，两台以上的相对罕见，略） 在高可用技术下，拔单机的电源不会影响应用，因为IBM用的HACMP，HP用的Service Guard之类的双机软件，最善于应付这种拔电的状况。电源一拔，备机马上就开始切换，一般中间会有几十秒到几分钟的中断。这时候业务部门发现怎么电脑突然慢了，但切换完毕后备机顶上后，应用很快就回复正常了，业务部门也不会太在意，不知道其实出过问题又被解决了。 我 碰过很搞笑的状况：配好的双机系统，系统掉电了自动切换了系统管理员都不知道，运行了一个多月我去现场无意中发现主机名变了，再仔细查查才发现居然已经切 换到另外一台服务器上了。后来在我的撺掇下，领导当然是把坏事当好事宣传了：xxx第一时间赶赴现场，在领导的大力关注下，力挽狂澜，敲下了重要的命令， 基于优秀的管理水平，解决xxx，化坏事为好事，xxx情绪稳定，再次体现xxx是一支来之能战战之能胜的训练有素的队伍，迅速，立即，有序，精干，全力 以赴，难度很大，全力救援…. 有趣的是，在个人电脑上，拔电源和拔网线效果差不多，都是系统马上就不能运作了。但在双机系统中，如果只拔一台机器的线缆的话，拔网线还没拔电源那么立竿见影来切换。因 为如果只拔其中一台设备的电源的话，系统通过心跳线等方式能知道另一台机器已经死了，马上会进行切换；不过如果只拔其中一台设备的网线的话，不会马上切 换。因为网络略有不稳定是很常见的现象，如果网络断个几秒就切换的话，有可能在切到一半的时候网络突然又好了，又要自动往回切，会出现各种争抢资源的古怪 现象。所以双机软件设计上一般是网络断了的话会等一段时间，确定网络真的断掉才切换。等多久视乎不同的软件而不一样，最典型的默认时间大约是20来秒。你 想想，24秒打NBA都算违例了，Reggie Miller 8.9秒都可以拿8分了，对高频交易软件来说，24秒和一万年差不多长哪，（在这次事故中，2秒就成交了2万多笔订单了）。所以拔电源比拔网线切换得快多了。当然如果两台设备主备机都同时拔网线或者电源的话，效果还是一样的，立毙。 必 须指出的是，双机高可用技术并不能保证100%的设备就运行正常，就好像大家乘车挂了安全带有了气囊就不能一定保证出车祸不挂，双机高可用技术只能保证某 些最常见的问题可以被解决。比如某个机器不小心被关掉了，单个机柜掉电了，单个网卡坏掉了之类，如果碰到了大规模的问题，比如两台设备都挂了，两个网卡都 坏了….这就要更高级的玩意，高可用技术的第三层：容灾系统出场了。不过跑题跑到牙买加了，下回再借题发挥吧。 还有，你以为要拔的线缆是这样子的： 但实际状况往往是这样的： 请拔。 8) 我也来瞎扯一下 其 实我在写这个答案的时候越写越意兴阑珊提不起精神。本来这部分是想扯扯我对光大IT的看法，不过现在扯成我写这篇文章的一些想法吧。俗话说，文无第一武无 第二，我感觉到知乎上当讨论到技术的时候，也有这么一些风气：不少人并没有仔细看完我写的东西，只是当我写的路数和他们理解的路数不是很一样的时候，或者 没有提到他们熟悉的一些东西，就开喷了，关键是喷的地方就是我正想指出的一些典型的错误想法。有的是他们没仔细看，有的是我没说清楚，有的是我还没来得及 写，当然，动作慢而且表达不够清晰，是我的错。 我说了我的想法很简单，我挺喜欢知乎这个平台，看到大家有不少理解误解的地方，我就借题发 挥，好为人师，写一些比较入门的没啥技术含量的但往往好多人包括做IT的人都不知道的东西，当科普也好，吹牛也好。真要我写有技术含量的东西，那是我工作 中的事，一来我做得多我烦，二来那些问题要我给意见是要收钱的。但今天这篇文章才写了半篇就感受到狼奔矢突，感受了这个世界的饿意，虽然也不是很有所谓， 但动力总觉得就少了不少。所以前面有的章节就没再展开了，该有图的也不去找不贴了... 9) 对别的答案的一些回应 关于"拔电源"与"拔电源线"的区别： 我 自我介绍是"借题发挥小化肥"，完整地思考一个问题是我对自己的要求，借题介绍一些相关东西是我的回答习惯。我知道"拔电源线"一略扩展成"拔电源"（其 实原文明明是"拔电源"嘛），必然有人会赶紧喷喷喷。所以我在第一稿就已经很明确地说明："其实拔电源这个词也是很模糊的词，可以有几种理解"，不知道大 家为什么都没看到，起码有10多人反复指出这个"错误"。 难道知道如何"拔电源"的人还不知道"拔电源线"？但知道"拔电源线"的人是否 知道电源是怎样拔出来的？在我本来的构思是会详细介绍一下机房的强电知识，贴些图说什么叫PDU，什么叫UEPO，甚至扯到PUE等，不过就被这些回应浇 灭了兴趣了，加上周末耽于唱卡拉OK，没兴趣详细更了。 关于排名第二的@姚杨 的回答： 这位同学对我很不礼貌，当然我是有礼貌的人而且是小鸡肚肠不肯教育没礼貌的人的人，所以我不会指出他的错误，只解释一下他对我的指责： 关 于机器位置：ETF套利应用的体系大约是这样的：1.套利交易客户端-----2.套利交易服务器端------3.上交所交易服务器（运行 EzOES）。1和2都在光大证券的机房，这样才有可能由客户自行通过各种方法（包括拔电）中止，上交所交易服务器当然不是光大可以停止的。 "ETF 套利专用设备"就是一个我随口编的识别这台设备的名字而已，姚同学自己也说了"不知道光大投资部内部怎么称呼"，就说了一堆和我说的内容无关的内容，最后 就说我不靠谱了。我详细解释"非专业人员不可能进机房，进了机房也不可能拔电源"，就被说成"特别喜欢强调设备、然后偷换概念到服务器、再到机房。进一步 强调断电的难度"，后面各种似乎没看懂我说什么的一堆反驳。其实我也不太看得懂他的叙述逻辑。 那时候我的文章还没写完，他就断定"拔电源的可能性很大，甚至通过暴力器械破坏"，（这个是我觉得最有喜感的，见过机架式服务器的同学都知道，真的很快能暴力破坏吗？）还跟我讨论"泼咖啡"，现在再看看我的文章里面的8种办法，到底哪些是靠谱的，相信大家都有目共睹了。 至于他自己文章中的不少基本概念错误，别的知友在他的评论下都有讨论，我就略了。 @余虹建 同学不仅猜到了我要说"为什么拔网线不一定有用的"原因，还提出了： 如果当初的架构是单点帐号登录，并从OS级别绑定了网络帐号管理的话，拔掉网线，系统运行就会昏厥，关机速度会因为检查uid 和gid大大减慢，而下单等前端程序会仍然在奔跑，只是速度会慢一些。 这个意见，是那么多回应中唯一我没想到的地方，让我的思路更完整了，特此鸣谢。 关于本文第一句： 有钱没文化就用苹果啊（一开始的版本是就用诺基亚，因为我自己用Lumia），其实就是图个押韵引出后面一句"想骗程序猿就说拔电源"，居然有不少人还真的反驳了。好认真，我喜欢！ 最后自我批评： 对 我来说，回答问题最有趣的是构思回答角度与文章结构的时候，在想好回答的大纲之后，回答问题的乐趣就已经获得了70%了，后面把想法详细写出来，还要应付 不靠谱的反驳的时候，真是一件好郁闷好消磨意志的事。工作中做项目时我写个大纲口头解释一下就可以让年轻一代去写详细的文档或者去干我审就好了，但回答知 乎问题还非要和上厕所和ooxx一样亲力亲为，所以如何以最少的字数获取最大的效果是一门我一直在思考的学问。我很无视那些说我想多了的人，因为正是因为 我还想得不够多，我才这么弱。 知乎日报中有个很尖锐的批评说得很有道理："这些东西对于熟悉机房的人来说太简单，但对于不熟悉机房的人来说又没兴趣看"，我非常同意这个批评，写了几千字才300来赞，性价比太低了。从产品运营的角度来说，就是定位目标用户不准确。看看我的 这个回答，其实比本回答离题得更厉害的了，都接近一千赞了。虽然赞对我没有任何意义，但却是很好的一个衡量我对某件事控制力的指标呢，养知乎ID就是一个很新鲜的育成类游戏嘛。 谢谢各位有耐心看完这么长的文章，再次对本文的逻辑和用词标准未达到我的标准而致歉。 